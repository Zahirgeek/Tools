# YOLOv8 目标检测和分类脚本使用说明

## 功能概述

这是一个基于YOLOv8的目标检测和分类脚本，能够处理图像和视频文件，根据检测结果将文件分类保存到不同的目录中，并可选保存YOLO格式标签。

## 主要功能

1. **目标检测**：使用YOLOv8模型对图像和视频进行目标检测
2. **自动分类**：根据检测结果自动将文件分类到不同目录
3. **视频帧处理**：对视频逐帧进行检测，输出分类后的图像帧
4. **批量处理**：支持批量处理多个文件和文件夹
5. **可视化支持**：可选择保存带有检测框的可视化结果
6. **YOLO标签导出**：可选将检测结果保存为YOLO格式标签，标签结构与输出图片一一对应
7. **并行处理**：支持多线程和批量推理，显著提升处理速度
8. **时间统计**：详细统计总运行时间、推理时间和性能指标

## 功能特点

- **高性能并行处理**：图像批量推理 + 多线程处理，速度提升3-10倍
- **智能任务调度**：自动区分图像和视频，采用最优处理策略
- **YOLO标签导出**：
  - 支持图片和视频帧的YOLO标签保存
  - 标签文件名与输出图片/帧一一对应
  - 标签目录结构与`vis`目录完全一致
- **完整时间统计**：
  - 总运行时间计算
  - 总推理时间统计
  - 平均单次推理时间（毫秒级精度）
  - 推理速度（FPS）
  - 平均每文件处理时间
- **灵活的输出结构**：保持与输入相同的目录结构
- **多格式支持**：支持常见的图像格式(.jpg, .png, .bmp等)和视频格式(.mp4, .avi, .mov等)
- **线程安全设计**：多线程环境下的统计信息同步

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 基本用法

```bash
python detect_and_classify.py -i <输入路径> -o <输出路径> -m <模型路径> -c <类别文件路径>
```

### 完整参数说明

```bash
python detect_and_classify.py \
    --input <输入路径> \
    --output <输出路径> \
    --model <模型路径> \
    --classes <类别文件路径> \
    --confidence <置信度阈值> \
    --max-workers <并行线程数> \
    --batch-size <批处理大小> \
    --visualize \
    --save-labels
    --single-folder
```

### 参数详解

- `--input, -i`：**必需**，输入路径（可以是单个图像/视频文件或包含图像/视频的目录）
- `--output, -o`：**必需**，输出路径（分类结果保存目录）
- `--model, -m`：**必需**，YOLO模型文件路径（.pt文件）
- `--classes, -c`：**必需**，类别文件路径（classes.txt）
- `--confidence, -conf`：可选，置信度阈值（默认：0.5）
- `--max-workers, -w`：可选，最大并行工作线程数（默认：4）
- `--batch-size, -b`：可选，图像批处理大小（默认：8）
- `--visualize, -v`：可选，是否保存可视化检测结果
- `--save-labels, -sl`：可选，是否保存YOLO格式标签（图片和视频帧均支持，标签结构与输出图片一一对应）
- `--single-folder, -sf`：可选，启用单文件夹模式，所有文件保存在同一个目录，不按类别分文件夹，可视化结果只保存一份，显示所有检测框。

## 使用示例

### 示例1：处理单个图像文件（带可视化+标签）

```bash
python detect_and_classify.py \
    -i "./test_image.jpg" \
    -o "./output" \
    -m "./th_person.pt" \
    -c "./classes.txt" \
    --confidence 0.6 \
    --visualize \
    --save-labels
```

处理完成后，将会产生以下输出：
- 分类结果：`./output/person/test_image.jpg`（如果检测到人）
- 可视化结果：`./output/vis/person/test_image.jpg`（带检测框）
- YOLO标签：`./output/labels/person/test_image.txt`（与图片同名）

### 示例2：高速批量处理图像目录（含标签）

```bash
python detect_and_classify.py \
    -i "./2025/07/03/FFOutput" \
    -o "./classified_output" \
    -m "./th_person.pt" \
    -c "./classes.txt" \
    --confidence 0.5 \
    --max-workers 8 \
    --batch-size 16 \
    --save-labels
```

### 示例3：并行处理视频文件（含标签）

```bash
python detect_and_classify.py \
    -i "./2025/07/03/" \
    -o "./video_output" \
    -m "./th_person.pt" \
    -c "./classes.txt" \
    --max-workers 4 \
    --visualize \
    --save-labels
```

### 示例4：单个视频文件处理（含标签）

```bash
python detect_and_classify.py \
    -i "./2025/07/03/2025-07-03-16-33-34-495.mkv" \
    -o "./video_output" \
    -m "./th_person.pt" \
    -c "./classes.txt" \
    --visualize \
    --save-labels
```

## 程序输出

### 控制台输出
运行过程中会在控制台显示详细的处理信息：

1. **初始化信息**：模型加载、文件统计等
2. **处理进度**：实时显示处理进度和状态
3. **统计信息**：处理完成后显示详细统计，包括：
   - 文件处理统计（总数、已处理、错误等）
   - 分类结果统计（各类别文件数量）
   - 视频帧统计（如有视频文件）
   - **详细时间统计**：
     - 总处理时间（秒）
     - 推理阶段总时长（秒）- 真正的推理耗时
     - 累计推理时间（秒）- 用于计算平均值
     - 推理时间占比（%）
     - 平均每文件处理时间（秒）
     - 总推理次数
     - 平均单次推理时间（毫秒）
     - 实际推理速度（FPS）

### 时间统计说明

- **总处理时间**：从程序开始到结束的总耗时
- **推理阶段总时长**：从第一次推理开始到最后一次推理结束的实际时间段（这是真正的"总推理时间"）
- **累计推理时间**：所有推理操作的累计耗时（在并行处理时会大于推理阶段总时长）
- **推理时间占比**：推理阶段在整个处理过程中的时间占比
- **平均单次推理时间**：每次模型推理的平均耗时（毫秒级精度）
- **实际推理速度（FPS）**：基于推理阶段总时长计算的每秒推理次数
- **平均每文件处理时间**：包含文件读取、推理、保存等完整流程的平均时间

## 输出结构

根据检测结果，输出目录将按以下结构组织：

### 图像文件输出结构
```
输出目录/
├── person/                    # 检测到人员的文件
│   ├── 2025/07/03/FFOutput/
│   │   ├── Image1.jpg        # 原图
│   │   └── ...
│   └── ...
├── unknown/                   # 未检测到目标的文件
│   ├── 2025/07/03/FFOutput/
│   └── ...
├── vis/                       # 可视化结果目录（如果启用）
│   ├── person/
│   │   ├── 2025/07/03/FFOutput/
│   │   │   ├── Image1.jpg    # 带检测框的可视化图像
│   │   │   └── ...
│   │   └── ...
│   └── unknown/
│       └── ...
├── labels/                    # YOLO标签目录（如果启用）
│   ├── person/
│   │   ├── 2025/07/03/FFOutput/
│   │   │   ├── Image1.txt    # 与图片同名的标签
│   │   │   └── ...
│   │   └── ...
│   └── unknown/
│       └── ...
└── 其他类别/                  # 其他检测到的类别
    └── ...
```

### 视频文件输出结构
视频文件会被逐帧处理并输出为图片，保存在以视频文件名命名的文件夹下：

```
输出目录/
├── person/                    # 检测到人员的帧
│   ├── 2025/07/03/
│   │   ├── 2025-07-03-16-33-34-495/    # 视频文件名文件夹
│   │   │   ├── frame_000001.jpg
│   │   │   ├── frame_000002.jpg
│   │   │   └── ...
│   │   └── 2025-07-03-16-43-49-066/
│   │       └── ...
├── unknown/                   # 未检测到目标的帧
│   ├── 2025/07/03/
│   │   ├── 2025-07-03-16-33-34-495/
│   │   └── ...
├── vis/                       # 可视化结果目录（如果启用）
│   ├── person/
│   │   ├── 2025/07/03/
│   │   │   ├── 2025-07-03-16-33-34-495/
│   │   │   │   ├── frame_000001.jpg    # 带检测框的可视化帧
│   │   │   │   ├── frame_000002.jpg
│   │   │   │   └── ...
│   │   │   └── ...
│   │   └── ...
│   └── unknown/
│       └── ...
├── labels/                    # YOLO标签目录（如果启用）
│   ├── person/
│   │   ├── 2025/07/03/
│   │   │   ├── 2025-07-03-16-33-34-495/
│   │   │   │   ├── frame_000001.txt    # 与帧图片一一对应的标签
│   │   │   │   ├── frame_000002.txt
│   │   │   │   └── ...
│   │   │   └── ...
│   │   └── ...
│   └── unknown/
│       └── ...
└── 其他类别/
    └── ...
```

## 可视化结果组织

当启用`--visualize`参数时，带有检测框的可视化结果会单独保存在`vis`目录中：

- **独立目录**：可视化结果保存在输出根目录下的`vis`文件夹
- **镜像结构**：`vis`目录内的结构与原始分类目录完全一致
- **相同文件名**：可视化图像使用与原图相同的文件名（不添加前缀）
- **便于对比**：原图和可视化结果分开存储，便于对比分析

例如：
- 原图：`输出目录/person/2025/07/03/FFOutput/Image1.jpg`
- 可视化：`输出目录/vis/person/2025/07/03/FFOutput/Image1.jpg`
- YOLO标签：`输出目录/labels/person/2025/07/03/FFOutput/Image1.txt`

## 视频处理策略

脚本采用逐帧处理策略：
- 读取视频的每一帧进行目标检测
- 将每一帧保存为JPG图片格式
- 帧文件名格式：`frame_000001.jpg`（6位数字，左侧补零）
- 根据每帧的检测结果分类保存到对应的类别文件夹
- 帧保存在以原视频文件名命名的子文件夹中
- 每处理100帧显示一次进度信息
- **YOLO标签与帧图片一一对应，标签名如`frame_000123.txt`，结构与vis目录完全一致** 