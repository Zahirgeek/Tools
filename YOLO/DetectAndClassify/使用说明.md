# YOLOv8 目标检测和分类脚本使用说明

## 概述

这个脚本是一个基于YOLOv8的目标检测和分类工具，能够处理图像和视频文件，根据检测结果将文件分类保存到不同的文件夹中。

## 功能特点

1. **多格式支持**：支持常见的图像格式（jpg, jpeg, png, bmp, tiff）和视频格式（mp4, avi, mov, mkv, flv, wmv）
2. **智能分类**：根据检测到的目标类别自动分类保存文件
3. **多类别处理**：如果图像中包含多个类别的目标，会将原图保存到多个分类文件夹
4. **未知目标处理**：没有检测到目标的文件会保存到"unknown"文件夹
5. **目录结构保持**：输出目录结构与输入目录结构保持一致
6. **可视化选项**：可选择保存带有检测框的可视化结果，单独保存在vis目录中
7. **详细统计**：提供完整的处理统计信息

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 基本用法

```bash
python detect_and_classify.py -i <输入路径> -o <输出路径> -m <模型路径> -c <类别文件路径>
```

### 完整参数说明

```bash
python detect_and_classify.py \
    --input <输入路径> \
    --output <输出路径> \
    --model <模型路径> \
    --classes <类别文件路径> \
    --confidence <置信度阈值> \
    --visualize
```

### 参数详解

- `--input, -i`：**必需**，输入路径（可以是单个图像/视频文件或包含图像/视频的目录）
- `--output, -o`：**必需**，输出路径（分类结果保存目录）
- `--model, -m`：**必需**，YOLO模型文件路径（.pt文件）
- `--classes, -c`：**必需**，类别文件路径（classes.txt）
- `--confidence, -conf`：可选，置信度阈值（默认：0.5）
- `--visualize, -v`：可选，是否保存可视化检测结果

## 使用示例

### 示例1：处理单个图像文件（带可视化）

```bash
python detect_and_classify.py \
    -i "./test_image.jpg" \
    -o "./output" \
    -m "./th_person.pt" \
    -c "./classes.txt" \
    --confidence 0.6 \
    --visualize
```

处理完成后，将会产生以下输出：
- 分类结果：`./output/person/test_image.jpg`（如果检测到人）
- 可视化结果：`./output/vis/person/test_image.jpg`（带检测框）

### 示例2：处理整个目录

```bash
python detect_and_classify.py \
    -i "./2025/07/03/FFOutput" \
    -o "./classified_output" \
    -m "./th_person.pt" \
    -c "./classes.txt" \
    --confidence 0.5
```

### 示例3：处理视频文件

```bash
python detect_and_classify.py \
    -i "./2025/07/03/2025-07-03-16-33-34-495.mkv" \
    -o "./video_output" \
    -m "./th_person.pt" \
    -c "./classes.txt" \
    --visualize
```

## 输出结构

根据检测结果，输出目录将按以下结构组织：

### 图像文件输出结构
```
输出目录/
├── person/                    # 检测到人员的文件
│   ├── 2025/07/03/FFOutput/
│   │   ├── Image1.jpg        # 原图
│   │   └── ...
│   └── ...
├── unknown/                   # 未检测到目标的文件
│   ├── 2025/07/03/FFOutput/
│   └── ...
├── vis/                       # 可视化结果目录（如果启用）
│   ├── person/
│   │   ├── 2025/07/03/FFOutput/
│   │   │   ├── Image1.jpg    # 带检测框的可视化图像
│   │   │   └── ...
│   │   └── ...
│   └── unknown/
│       └── ...
└── 其他类别/                  # 其他检测到的类别
    └── ...
```

### 视频文件输出结构
视频文件会被逐帧处理并输出为图片，保存在以视频文件名命名的文件夹下：

```
输出目录/
├── person/                    # 检测到人员的帧
│   ├── 2025/07/03/
│   │   ├── 2025-07-03-16-33-34-495/    # 视频文件名文件夹
│   │   │   ├── frame_000001.jpg
│   │   │   ├── frame_000002.jpg
│   │   │   └── ...
│   │   └── 2025-07-03-16-43-49-066/
│   │       └── ...
├── unknown/                   # 未检测到目标的帧
│   ├── 2025/07/03/
│   │   ├── 2025-07-03-16-33-34-495/
│   │   └── ...
├── vis/                       # 可视化结果目录（如果启用）
│   ├── person/
│   │   ├── 2025/07/03/
│   │   │   ├── 2025-07-03-16-33-34-495/
│   │   │   │   ├── frame_000001.jpg    # 带检测框的可视化帧
│   │   │   │   ├── frame_000002.jpg
│   │   │   │   └── ...
│   │   │   └── ...
│   │   └── ...
│   └── unknown/
│       └── ...
└── 其他类别/
    └── ...
```

## 可视化结果组织

当启用`--visualize`参数时，带有检测框的可视化结果会单独保存在`vis`目录中：

- **独立目录**：可视化结果保存在输出根目录下的`vis`文件夹
- **镜像结构**：`vis`目录内的结构与原始分类目录完全一致
- **相同文件名**：可视化图像使用与原图相同的文件名（不添加前缀）
- **便于对比**：原图和可视化结果分开存储，便于对比分析

例如：
- 原图：`输出目录/person/2025/07/03/FFOutput/Image1.jpg`
- 可视化：`输出目录/vis/person/2025/07/03/FFOutput/Image1.jpg`

## 视频处理策略

脚本采用逐帧处理策略：
- 读取视频的每一帧进行目标检测
- 将每一帧保存为JPG图片格式
- 帧文件名格式：`frame_000001.jpg`（6位数字，左侧补零）
- 根据每帧的检测结果分类保存到对应的类别文件夹
- 帧保存在以原视频文件名命名的子文件夹中
- 每处理100帧显示一次进度信息

## 性能优化建议

1. **调整置信度阈值**：根据具体需求调整`--confidence`参数，提高阈值可以减少误检，降低阈值可以增加检测召回率
2. **批量处理**：对于大量文件，建议分批处理以避免内存溢出
3. **GPU加速**：确保安装了CUDA版本的PyTorch以利用GPU加速
4. **视频处理优化**：对于长视频，建议先分割成较短的片段再处理，或者在处理过程中监控磁盘空间
